# 履带车SAC训练优化指南

## 概述

本指南详细介绍了如何通过SAC算法训练出一个能够快速规划路径并且能够实时动态避障的履带车智能体。我们通过以下几个方面的优化来实现这一目标：

1. **增强感知能力** - 增加边界感知信息
2. **改进决策逻辑** - 优化奖励函数，增加主动避障
3. **优化训练过程** - 改进网络结构和超参数
4. **创建多样化场景** - 设计渐进式训练场景
5. **实现安全约束** - 确保动作在安全范围内

## 主要改进

### 1. 状态表示增强

**原始状态 (17维)**:
- 车辆状态: 速度、角速度、目标距离、目标相对位置 (5维)
- 障碍物信息: 最近3个障碍物的位置和速度 (12维)

**优化后状态 (20维)**:
- 车辆状态: 速度、角速度、目标距离、目标相对位置 (5维)
- 障碍物信息: 最近3个障碍物的位置和速度 (12维)
- **边界感知**: 前方、左前、右前方向的边界距离 (3维)

### 2. 奖励函数优化

**新增奖励项**:
- **安全距离惩罚**: 当与障碍物距离小于安全阈值时给予连续惩罚
- **碰撞惩罚增强**: 将碰撞惩罚从-500增加到-800
- **转向平滑奖励**: 增加转向惩罚权重，鼓励平滑转向

### 3. 网络结构优化

**Actor网络**:
- 增加网络深度: 2层 → 3层
- 添加Dropout: 防止过拟合
- 增加网络宽度: 256 → 512

**Critic网络**:
- 增加网络深度: 2层 → 3层
- 添加Dropout: 提高泛化能力
- 双Q网络结构保持不变

### 4. 训练超参数优化

- **训练轮数**: 1000 → 2000
- **每轮步数**: 1000 → 1500
- **批次大小**: 256 → 512
- **预热步数**: 5000 → 10000
- **经验池大小**: 1M → 2M

### 5. 安全约束系统

实现多层次安全约束:
- **速度限制**: 确保速度在合理范围内
- **转弯半径约束**: 基于车辆最小转弯半径限制差速
- **加速度限制**: 限制加速度变化率
- **角速度限制**: 限制最大角速度

## 使用方法

### 1. 训练模型

```bash
# 使用优化配置训练
python train_optimized.py --cfg config_optimized.yaml --tag my_training

# 或者直接使用原始脚本
python train_rl.py --cfg config_optimized.yaml --tag my_training
```

### 2. 评估模型

```bash
# 自动查找最新模型进行评估
python eval_optimized.py --cfg config_optimized.yaml --episodes 20

# 指定特定模型进行评估
python eval_optimized.py --cfg config_optimized.yaml --actor demo/demo_outputs/sac_model/actor_ep_2000.pth
```

### 3. 监控训练

训练过程中会生成以下日志:
- **TensorBoard日志**: `runs/` 目录下
- **CSV指标**: `runs/run_name/metrics.csv`
- **模型检查点**: `demo/demo_outputs/sac_model/`

## 配置文件说明

### config_optimized.yaml

```yaml
train:
  max_episodes: 2000          # 训练轮数
  max_steps: 1500            # 每轮最大步数
  batch_size: 512            # 批次大小
  warmup_steps: 10000        # 预热步数

network:
  hidden_dim: 512            # 网络宽度

optimizer:
  gamma: 0.99                # 折扣因子
  tau: 0.005                 # 软更新参数
  actor_lr: 3e-4             # Actor学习率
  critic_lr: 3e-4            # Critic学习率
  replay_size: 2000000       # 经验池大小

reward:
  reach_goal_bonus: 500.0    # 到达目标奖励
  collision_penalty: -800.0  # 碰撞惩罚
  safety_distance: 15.0      # 安全距离
  safety_penalty_weight: 1.0 # 安全距离惩罚权重
```

## 训练场景设计

### 阶段1: 基础训练 (Episodes 1-500)
- 70% 基础路径规划场景
- 20% 静态避障场景
- 10% 简单动态避障场景

### 阶段2: 避障训练 (Episodes 501-1200)
- 30% 基础路径规划场景
- 30% 静态避障场景
- 35% 动态避障场景
- 5% 边界感知场景

### 阶段3: 综合训练 (Episodes 1201-2000)
- 20% 基础路径规划场景
- 20% 静态避障场景
- 45% 复杂动态避障场景
- 15% 边界感知场景

## 性能指标

### 训练监控指标
- **成功率**: 到达目标、避障成功、边界遵守
- **效率指标**: 完成时间、路径长度、平均速度
- **安全指标**: 碰撞率、越界率、最小安全距离

### 期望性能
- **到达目标成功率**: > 85%
- **避障成功率**: > 90%
- **碰撞率**: < 5%
- **平均完成时间**: 比基线减少20%

## 故障排除

### 常见问题

1. **训练不收敛**
   - 检查场景多样性
   - 调整学习率
   - 增加预热步数

2. **碰撞率过高**
   - 增加安全距离惩罚权重
   - 检查安全约束是否生效
   - 增加避障场景比例

3. **速度过慢**
   - 调整速度奖励权重
   - 减少转向惩罚
   - 检查动力学参数设置

4. **边界越界**
   - 增加边界感知场景
   - 调整边界惩罚权重
   - 检查边界感知计算

### 调试技巧

1. **可视化训练过程**
   ```bash
   python eval_optimized.py --cfg config_optimized.yaml --episodes 5
   ```

2. **监控训练指标**
   ```bash
   tensorboard --logdir runs/
   ```

3. **检查模型性能**
   - 查看CSV日志文件
   - 分析不同场景的成功率
   - 监控奖励函数各项指标

## 进一步优化建议

### 1. 高级技术
- **课程学习**: 实现自动难度调整
- **多智能体训练**: 增加环境复杂性
- **迁移学习**: 从仿真到实车的迁移

### 2. 工程优化
- **并行训练**: 使用多GPU加速
- **分布式训练**: 大规模场景训练
- **模型压缩**: 减少推理时间

### 3. 安全增强
- **不确定性估计**: 增加置信度评估
- **故障检测**: 异常情况处理
- **人机协作**: 人工干预机制

## 总结

通过以上优化，您的SAC智能体将具备:

1. **更强的感知能力**: 能够感知道路边界和障碍物
2. **更智能的决策**: 主动避障而非被动反应
3. **更稳定的训练**: 优化的网络结构和超参数
4. **更安全的控制**: 多层次安全约束系统
5. **更好的泛化**: 多样化的训练场景

这些改进将显著提高履带车在复杂环境下的路径规划能力和动态避障性能。
